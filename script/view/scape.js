import*as r from"../control/mechanic/combat.js";import*as t from"../control/audio.js";import*as i from"../control/engine.js";import*as e from"../control/rpg.js";import*as s from"./sidebar.js";import*as o from"./hotbar.js";import*as n from"../control/keyboard.js";const a=document.querySelector("#scape"),l=a.querySelector(".message"),c=Array.from(a.querySelectorAll(".unit")),h="Auto-fight disabled, to fight press a key or click...";var d=!1;class f{constructor(t,e){this.director=t,this.floor=e;t=this.units.find(t=>t!=i.hero);this.intro=r.report(t,"","intro"),this.explore=i.explore}lock(){r.start(),i.autoexplore(!1)}close(){d=!1,a.classList.add("hidden"),r.end(),this.director.wrap(),i.turn(),this.explore&&(i.fight?s.explore(!0):s.explore(!1))}get units(){return this.director.units}draw(){a.className="",a.classList.add("purple");var t=this.intro,e=[`The ${t.unit} approaches!`],r=(i.fight||e.push(h),t.message=e.join("<br>"),this.units);for(let t=0;t<r.length;t++){var s=c[t],o=r[t];s.unit=o,this.style(s,1,o.classname)}}show(){a.classList.remove("hidden"),d=this,i.fight||this.next(!0)}style(t,e,r=!1){var s,o=t.classList;for(s of Array.from(o).slice(e))o.remove(s);r&&o.add(r)}next(t=!1){if(i.fight||t)if(this.director.end()){for(var e of this.units)e.dead&&e.remove();this.close()}else{t=this.director.flee(),t=t?t.report(`The ${t} flees!`,"flight"):this.director.report();t.damage(),l.style.animation="none",t!=this.intro||i.fight?(l.style.opacity="",setTimeout(()=>l.style.animation="",100)):l.style.opacity=1,l.innerHTML=t.toString(),this.style(l,1,t.effect);let e=t.unit;e&&this.style(c.find(t=>t.unit==e),2,t.effect),s.update()}}round(){o.update()}}function p(t){!d||(t=t.key)&&0<=n.combat.indexOf(n.binds.get(t))||d.next(!0)}function m(){t.listeners.push(t=>{d&&t%2==0&&d.next()}),window.onkeypress=p,a.onclick=p}export{f as Scape,m as setup};