import*as r from"../../view/map.js";import*as e from"../point.js";import*as t from"../actor/hero.js";import*as o from"../../control/rpg.js";import*as s from"../actor/chest.js";import*as i from"../../control/digger.js";import*as a from"../actor/stairs.js";import*as n from"../../control/engine.js";var h="#",l=" ";class c{constructor(t){this.dungeon=t,this.tiles=Array.from(new Array(r.width),()=>new Array(r.height).fill(h)),this.actors=[],this.visible=e.range(0,0,r.width-1,r.height-1),this.entrance=new e.Point(o.roll(0,r.width-1),o.roll(0,r.height-1)),o.chancein(2)?this.entrance.x=o.chancein(2)?0:r.width-1:this.entrance.y=o.chancein(2)?0:r.height-1}get depth(){return n.dungeon.floors.indexOf(this)}get last(){return this.depth==n.dungeon.floors.length-1}populate(){var i=[],e=(this.last||i.push(new a.Down),o.rolldie(5,4));for(let t=0;t<e;t++)i.push(new s.Chest);for(let e of i){for(;-1==e.x||this.actors.find(t=>e!=t&&t.x==e.x&&t.y==e.y);)e.location.x=o.roll(2,r.width-2),e.location.y=o.roll(2,r.height-2);this.place(e,e.x,e.y)}this.place(new a.Up,this.entrance.x,this.entrance.y)}generate(){if(p=!0,!(1<this.actors.length)){this.populate();for(var t of this.actors)this.tiles[t.x][t.y]=l;var e;for(e of new i.Digger(this).generate())this.tiles[e.x][e.y]=l;p=!1}}wall(t,e){return this.tiles[t][e]==h}place(t,e,i){this.actors.push(t),t.place(e,i)}move(t,e,i){let o=t.location.clone();return o.x+=e,o.y+=i,!(!o.validate(0,0,r.width,r.height)||this.tiles[o.x][o.y]==h)&&((e=this.actors.find(t=>t.location.equals(o)))&&(e.activate(),n.floor!=this)?void 0:(t.location=o,!0))}enter(t){var e;a.last instanceof a.Up?(e=this.actors.find(t=>t instanceof a.Down).location,this.place(t,e.x,e.y)):(0==(e=this.entrance.clone()).x?e.x+=1:0==e.y?e.y+=1:e.x==r.width-1?--e.x:--e.y,this.place(t,e.x,e.y),this.generate())}remove(t){this.actors.splice(this.actors.indexOf(t),1)}}var p=!1;export{h as wall,l as empty,c as Floor,p as generating};