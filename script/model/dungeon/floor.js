import*as n from"../../view/map.js";import*as i from"../point.js";import*as t from"../unit/actor/hero/hero.js";import*as s from"../../control/rpg.js";import*as r from"../unit/chest.js";import*as e from"../../control/digger.js";import*as o from"../unit/stairs.js";import*as h from"../../control/engine.js";var l="#",a=" ";class c{constructor(t){this.level=t,this.tiles=Array.from(new Array(n.width),()=>new Array(n.height).fill(l)),this.units=[],this.visible=i.range(0,0,n.width-1,n.height-1),this.entrance=new i.Point(s.roll(0,n.width-1),s.roll(0,n.height-1)),s.chancein(2)?this.entrance.x=s.chancein(2)?0:n.width-1:this.entrance.y=s.chancein(2)?0:n.height-1}get depth(){return h.dungeon.floors.indexOf(this)}get last(){return this.depth==h.dungeon.floors.length-1}populate(){var e=[],i=(this.last||e.push(new o.Down),s.rolldie(5,4));for(let t=0;t<i;t++)e.push(new r.Chest);for(let i of e){for(;-1==i.x||this.units.find(t=>i!=t&&t.x==i.x&&t.y==i.y);)i.location.x=s.roll(2,n.width-2),i.location.y=s.roll(2,n.height-2);this.place(i,i.x,i.y)}this.place(new o.Up,this.entrance.x,this.entrance.y)}generate(){if(f=!0,!(1<this.units.length)){this.populate();for(var t of this.units)this.tiles[t.x][t.y]=a;var i;for(i of new e.Digger(this).generate())this.tiles[i.x][i.y]=a;f=!1}}wall(t,i){return this.tiles[t][i]==l}place(t,i,e){this.units.push(t),t.place(i,e)}move(t,i,e){let s=t.location.clone();return s.x+=i,s.y+=e,!(!s.validate(0,0,n.width,n.height)||this.tiles[s.x][s.y]==l)&&((i=this.units.find(t=>t.location.equals(s)))&&(i.activate(),h.floor!=this)?void 0:(t.location=s,!0))}enter(t){var i;o.last instanceof o.Up?(i=this.units.find(t=>t instanceof o.Down).location,this.place(t,i.x,i.y)):(0==(i=this.entrance.clone()).x?i.x+=1:0==i.y?i.y+=1:i.x==n.width-1?--i.x:--i.y,this.place(t,i.x,i.y),this.generate())}remove(t){this.units.splice(this.units.indexOf(t),1)}challenge(){let t=this.level,i=1;for(;!(4<=i&&i<=5);)((i=s.roll())<=3||6==i)&&(t+=1);return 5<t?5:1<t?1:t}}var f=!1;export{l as wall,a as empty,c as Floor,f as generating};