import*as i from"../../view/map.js";import*as a from"../../view/sidebar.js";import*as o from"../../view/hotbar.js";import*as d from"../engine.js";import*as l from"../rpg.js";import*as n from"../driver.js";function s(e,t){return e.roll(e.force)?t.roll(t.speed)?(a.log(t+" dodges... "),e.dead||e.dodge(e,t),t.dead||t.dodge(e,t),!1):(!e.dead&&!e.hit(e,t)||!t.dead&&!t.hit(e,t)||e.dead||t.dead||t.damage(),!0):(a.log(e+" misses... "),!1)}function f(e){e==d.hero&&(e.cool(),t())}function g(e,t){let r=new Map([[e,0],[t,0]]);for(;r.get(e)==r.get(t);)r.set(e,e.initiative),r.set(t,t.initiative);return[e,t].sort(e=>-r.get(e))}function e(e,t){if(t.hp){var r;if(n.delay(),!(d.debug&&d.debug.combat))return s(e=(r=g(e,t))[0],t=r[1])||s(t,e),f(e),f(t),i.update(),a.update(),o.update(),(e.dead||t.dead)&&(n.delay(!1),d.turn()),!0;t.remove()}}function t(e=!0){if(o.active&&!o.active.cooling&&!d.fight)return!1;let t=d.hero.gear.filter(e=>!e.cooling);if(0==t.length)return o.deactivate(),!1;l.shuffle(gear),t.sort((e,t)=>e.level-t.level).reverse();var r=(t=t.filter(e=>e.level==t[0].level))[t.length-1];return r!=o.active&&(e&&(o.activate(r),o.update()),r)}export{e as fight,t as autofight};